---
title: "Capstone"
author: "Jonathon Sun"
date: "1/14/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE,
	include = FALSE
)
pacman::p_load(opentripplanner, tidytransit, tidyverse, sf, tigris, ggmap, tidycensus, stm)

register_google(key = "AIzaSyDIDS0OgrYmmrJO221DhqIaEnMq9tQrMr0") 
options(scipen = 999)
options(scipen =  "sf")

source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")
```

# Datasets

```{r}
# IPEDS Post-secondary institutions
Remove <- c("OBJECTID","CBSA","NMCBSA","CBSATYPE","CSA","SLDU","SCHOOLYEAR","NECTA","NMNECTA","CD","SLDL","NMCSA","LOCALE")

Universities <- st_read("https://opendata.arcgis.com/datasets/a15e8731a17a46aabc452ea607f172c0_0.geojson") %>%
                    select(!Remove) %>%
                    filter(STATE == "PA") %>%
                    filter(NMCNTY == "Philadelphia County") %>%
                    st_as_sf()

# TIGRIS Philadelphia Census Tracts -------------------------------
Philadelphia_tracts <- tracts(state = "PA", county = "Philadelphia County") %>%
  st_transform(st_crs(Universities))

ggplot() +
  geom_sf(data = Philadelphia_tracts)

# Census Tract centroids as points -------------------------------------
Philadelphia_Centroids <- Philadelphia_tracts %>%
  st_centroid() %>%
  st_transform(st_crs(Universities))

ggplot() +
  geom_sf(data = Philadelphia_Centroids)

# TIGRIS Philadelphia School Districts ---------------------------------
Philadelphia_School_District <- school_districts(state = "PA", type = "unified") %>%
  st_transform(st_crs(Universities)) %>%
  st_intersection(st_union(Philadelphia_tracts))

ggplot() +
  geom_sf(data = Philadelphia_School_District)

# Safegraph data on Education
Philly_Education <- read.csv("Data\\geometry.csv") %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant") %>%
  st_transform(crs = "EPSG:4326")%>%
  select(!c(1,2,4,6,7,9,10,11,13,14)) %>%
  mutate(Higher_Education = ifelse(location_name %in% Universities$NAME | 
                                   street_address %in% Universities$STREET |
                                    grepl("University of Penn", location_name) == TRUE, TRUE, FALSE),
         Free_Library = ifelse(grepl("Free Library", location_name) == TRUE, TRUE, FALSE),
         Kumon = ifelse(grepl("Kumon", location_name) == TRUE, TRUE, FALSE),
         High_School = ifelse(grepl("Hs", location_name) == TRUE, TRUE, FALSE),
         Middle_School = ifelse(grepl("\\<Ms\\>", location_name) == TRUE, TRUE, FALSE),
         Elementary_School = ifelse(grepl("\\<Sch\\>", location_name) == TRUE, TRUE, FALSE),
         Charter_School = ifelse(grepl("\\<Cs\\>", location_name) == TRUE, TRUE, FALSE))

Philly_Education_Long <- pivot_longer(Philly_Education, 7:13, names_to = "Type_of_Ed", values_to = "Type_of_Ed_Yes") %>%
                              filter(Type_of_Ed_Yes == TRUE) %>%
                              select(!Type_of_Ed_Yes)
Philly_Education_Long_FALSE <- pivot_longer(Philly_Education, 7:13, names_to = "Type_of_Ed", values_to = "Type_of_Ed_Yes") %>%
                              filter(Type_of_Ed_Yes == FALSE) %>%
                              group_by(location_name, street_address) %>%
                              summarize(n = n()) %>%
                              filter(n > 6) %>%
                              mutate(Type_of_Ed = "Not_Categorized") %>%
                              left_join(Philly_Education %>%
                                            st_drop_geometry() %>%
                                            select(!7:(ncol(Philly_Education)-1)), 
                                        by = c("location_name","street_address")) %>%
                              select(!c("Higher_Education","n"))
Philly_Education_Long <- rbind(Philly_Education_Long,Philly_Education_Long_FALSE)

# Tidycensus --------------------------------
A <- load_variables(2019,
                            "acs5",
                            cache = FALSE) %>%
              filter(concept == "RACE")  %>%
              mutate(Merge_name = paste(name,"E", sep =""))

B <- load_variables(2019,
                            "acs5",
                            cache = FALSE) %>%
              filter(grepl("ASIAN ALONE BY SELECTED GROUPS", concept)) %>%
              mutate(Merge_name = paste(name,"E", sep ="")) %>%
              slice(-1)

Variables <- bind_rows(A,B) %>%
                mutate(
                  label = str_remove(label,"Estimate!!"),
                  label = str_remove(label,"Total:!!"),
                  label = str_remove_all(label,"!!"),
                  label = str_replace_all(label,":"," "),
                  label = str_trim(label),
                  label = str_replace_all(label," ","_"),
                  label = str_replace(label,"Total","Total_Population")
                )

ACS.wide <-  get_acs(geography = "tract", 
                          variables = Variables$name, 
                          state = "PA",
                          county = "Philadelphia",
                          output = "wide",
                          geometry = TRUE,
                     year = 2019) %>% 
                dplyr::select (GEOID, NAME, ends_with("E")) %>%
                st_transform(st_crs(Universities))

col.from <- colnames(ACS.wide)

colnames(ACS.wide)

cols <- Variables$label
namestoAdd <- c("GEOID","NAME")
cols <- append(namestoAdd, cols)
cols.to <- append(cols, "geometry")

## this function below renames all the columns based on the two lists that we made. that being col.from the variables original names to cols.to are the names that we made from the list of census data.
ACS.wide  <- ACS.wide  %>%
                   rename_at(vars(col.from), function(x) cols.to)
ACS.Long <- pivot_longer(ACS.wide,4:(ncol(ACS.wide)-1), names_to = "Race_Ethnicity", values_to = "Frequency") %>%
      mutate(Percentage = (Frequency/Total_Population)*100,
             Year = 2019)

Years <- seq(from = 2011, to = 2018, by = 1)

for(i in 1:length(Years)) {
A <- load_variables(Years[i],
                            "acs5",
                            cache = FALSE) %>%
              filter(concept == "RACE")  %>%
              mutate(Merge_name = paste(name,"E", sep =""))

B <- load_variables(Years[i],
                            "acs5",
                            cache = FALSE) %>%
              filter(grepl("ASIAN ALONE BY SELECTED GROUPS", concept)) %>%
              mutate(Merge_name = paste(name,"E", sep ="")) %>%
              slice(-1)

Variables <- bind_rows(A,B) %>%
                mutate(
                  label = str_remove(label,"Estimate!!"),
                  label = str_remove(label,"Total:!!"),
                  label = str_remove_all(label,"!!"),
                  label = str_replace_all(label,":"," "),
                  label = str_trim(label),
                  label = str_replace_all(label," ","_"),
                  label = str_replace(label,"Total","Total_Population")
                )  
  
  
ACS.wide <-  get_acs(geography = "tract", 
                          variables = Variables$name, 
                          state = "PA",
                          county = "Philadelphia",
                          output = "wide",
                          geometry = TRUE,
                     year = Years[i]) %>% 
                dplyr::select (GEOID, NAME, ends_with("E")) %>%
                st_transform(st_crs(Universities))

col.from <- colnames(ACS.wide)

colnames(ACS.wide)

cols <- Variables$label
namestoAdd <- c("GEOID","NAME")
cols <- append(namestoAdd, cols)
cols.to <- append(cols, "geometry")  
  
ACS.wide  <- ACS.wide  %>%
                   rename_at(vars(col.from), function(x) cols.to)
f <- pivot_longer(ACS.wide,4:(ncol(ACS.wide)-1), names_to = "Race_Ethnicity", values_to = "Frequency") %>%
      mutate(Percentage = (Frequency/Total_Population)*100,
             Year = Years[i])  
ACS.Long <- rbind(ACS.Long,f)  
}

#Geocoded data using Google Maps ---------------------------------------

ACS.Long <- ACS.Long %>%
  mutate(Race_Ethnicity = str_remove(Race_Ethnicity,"Total_Population"),
         Race_Ethnicity = str_replace(Race_Ethnicity,"Chinese_,_except_Taiwanese","Chinese,_except_Taiwanese"),
         Race_Ethnicity = str_replace(Race_Ethnicity,"Two_or_more_racesTwo_races_including_Some_other_race","Two_or_more_races_Two_races_including_Some_other_race"),
         Race_Ethnicity = str_replace(Race_Ethnicity,"Two_or_more_racesTwo_races_excluding_Some_other_race,_and_three_or_more_races","Two_or_more_races_Two_races_excluding_Some_other_race,_and_three_or_more_races"))

Locations <- c("Vietlead Philadelphia","Asian Americans United Philadelphia")

locations_LatLon <- geocode(location = Locations)
locations_Shp <- locations_LatLon %>% 
  rename(Longitude = lon,
         Latitude = lat) %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326, agr = "constant") %>%
  st_transform(st_crs(Universities)) %>%
  cbind(Locations)
```

# STM

```{r STM}
# Page 7 instructions https://cran.r-project.org/web/packages/stm/vignettes/stmVignette.pdf

processed <- textProcessor(Philly_Education_Long$location_name, metadata = Philly_Education_Long)
out <- prepDocuments(processed$documents, processed$vocab, processed$meta)
docs <- out$documents
vocab <- out$vocab
meta <- out$meta

#Page 8
plotRemoved(processed$documents, lower.thresh = seq(1, 200, by = 100)) #Clears infrequent words
out <- prepDocuments(processed$documents, processed$vocab, processed$meta, lower.thresh = 15)

#Page 9
poliblogPrevFit <- stm(documents = out$documents, 
                       vocab = out$vocab, 
                       K = 20, 
                       max.em.its = 75, 
                       data = out$meta, 
                       init.type = "Spectral")

poliblogSelect <- selectModel(out$documents, out$vocab, K = 20, 
                              max.em.its = 75, 
                              data = out$meta, 
                              runs = 20, 
                              seed = 8458159)

plotModels(poliblogSelect, pch=c(1,2,3,4), legend.position="bottomright")

storage <- searchK(out$documents, 
                   out$vocab, 
                   K = c(7, 10),
                   data = meta)


```
# Summary Statistics

## Geometry Data
```{r echo=TRUE, message=FALSE, warning=FALSE}
ggplot() +
  geom_sf(data = Philly_Education_Long %>%
                    filter(!Type_of_Ed == "Not_Categorized"), aes(color = Type_of_Ed,
                                                                  shape = Type_of_Ed)) +
  geom_sf(data = Philadelphia_tracts, 
          fill = "transparent") +
  geom_sf(data = locations_Shp) +
  labs(title = "Education Institutions in Philadelphia",
       subtitle = "By institutional category") +
  mapTheme()

ggplot() +
  geom_sf(data = ACS.Long, aes(fill = Frequency)) +
  facet_wrap(~Race_Ethnicity) +
  mapTheme()
```


```{r}

file_names <- list.files("zip_out")
files <- paste0(directory,"/zip_out/",file_names,"/home_panel_summary.csv")

```